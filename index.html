<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZT çŒœæ•¸å­— - è¨»å†ŠåŒæ­¥ç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #f5f6fa; --cheat: #e84118; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        /* è¨»å†Šç™»å…¥å½ˆçª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 2rem; border-radius: 20px; width: 85%; }

        .cheat-panel { color: var(--cheat); font-weight: bold; font-size: 14px; margin-bottom: 15px; border: 2px dashed var(--cheat); padding: 10px; border-radius: 12px; background: #fff5f5; }
        .range-box { font-size: 3rem; font-weight: bold; color: #2f3640; margin: 20px 0; }
        
        input { width: 100%; box-sizing: border-box; padding: 14px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.97); }
        .status { font-size: 12px; color: #7f8c8d; background: #f1f2f6; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: left; word-break: break-all; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="!isLoggedIn" class="modal">
        <div class="modal-content">
            <h2 v-if="!hasLocalAccount">ğŸ†• è¨»å†ŠéŠæˆ²å¸³è™Ÿ</h2>
            <h2 v-else>ğŸ” ç™»å…¥ç³»çµ±</h2>
            <input v-model="auth.username" placeholder="ä½¿ç”¨è€… ID (ä¾‹å¦‚: 410205)">
            <input v-model="auth.password" type="password" placeholder="å¯†ç¢¼ (ä¾‹å¦‚: 981103)">
            <button @click="handleAuth">{{ hasLocalAccount ? 'ç™»å…¥' : 'è¨»å†Šä¸¦å­˜è‡³æœ¬åœ°' }}</button>
            <p v-if="!hasLocalAccount" style="font-size: 11px; color: #e84118; margin-top:10px;">* è³‡æ–™å°‡é€é ZeroTier å‚³è¼¸ä¸¦å„²å­˜åœ¨æœ¬åœ°</p>
        </div>
    </div>

    <div v-else>
        <h2>ğŸ”¢ ZT å¤šäººå°å±€</h2>
        
        <div v-if="isCheater" class="cheat-panel">
            ğŸ•µï¸ å®˜æ–¹ä¸Šå¸è¦–è§’ï¼šè¬åº•ç‚º {{ remoteAnswer }}
        </div>

        <div class="status">
            ğŸ‘¤ ç™»å…¥èº«ä»½ï¼š{{ user.username }}<br>
            ğŸ†” æˆ‘çš„ IDï¼š{{ myId || 'å–å¾—ä¸­...' }}
        </div>

        <div v-if="!gameStarted">
            <div v-if="isHost && !answerSet">
                <p>è«‹è¨­å®šæœ¬å±€è¬åº• (1-100)ï¼š</p>
                <input type="number" v-model.number="inputAnswer" placeholder="è¼¸å…¥æ•¸å­—">
                <button @click="confirmAnswer">é–å®šç­”æ¡ˆ</button>
            </div>
            
            <div v-else-if="!isJoined">
                <button @click="initHost">æˆ‘æ˜¯æˆ¿ä¸» (é–‹æ–°å±€)</button>
                <div style="margin: 15px; color:#ccc;">â€”â€” æˆ– â€”â€”</div>
                <input v-model="targetId" placeholder="è²¼ä¸Šæˆ¿ä¸»çš„ ID">
                <button @click="joinGame" style="background:#2ecc71">åŠ å…¥æœ‹å‹çš„å±€</button>
            </div>

            <div v-else>
                <p>å·²é€£ç·šç©å®¶ï¼š{{ players.length }}</p>
                <div v-for="p in players" style="font-size:14px; color:#2980b9;">Â· {{ p.name }}</div>
                <button v-if="isHost" @click="startGame" style="margin-top:20px" :disabled="!answerSet">é–‹å§‹å°å±€</button>
                <p v-else style="font-style:italic; color:#7f8c8d; margin-top:15px;">ç­‰å¾…æˆ¿ä¸»ç™¼èµ·...</p>
            </div>
        </div>

        <div v-else>
            <div class="range-box">{{ range.min }} ~ {{ range.max }}</div>
            <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold; font-size:1.3rem; animation: pulse 1s infinite;">ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼</p>
            <p v-else>ç­‰å¾…ç©å®¶ ã€{{ players[turnIndex]?.name }}ã€‘ çŒœæ¸¬...</p>

            <div v-if="isMyTurn">
                <input type="number" v-model.number="guess" :placeholder="'è«‹è¼¸å…¥æ•¸å­—'">
                <button @click="sendGuess">ç™¼é€çŒœæ¸¬</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

createApp({
    setup() {
        const auth = ref({ username: '', password: '' });
        const user = ref(null);
        const isLoggedIn = ref(false);
        const hasLocalAccount = ref(!!localStorage.getItem('zt_v3_account'));

        const myId = ref('');
        const targetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const answerSet = ref(false);
        const inputAnswer = ref(null);
        
        const players = ref([]);
        const turnIndex = ref(0);
        const range = ref({ min: 1, max: 100 });
        const guess = ref(null);
        const localAnswer = ref(0);
        const remoteAnswer = ref('?');

        let peer, connections = [];

        const isCheater = computed(() => user.value?.username === '410205' && user.value?.password === '981103');

        const handleAuth = () => {
            if (!auth.value.username || !auth.value.password) return alert("è«‹å¡«å¯«å¸³å¯†");
            const stored = localStorage.getItem('zt_v3_account');
            
            if (!stored) {
                localStorage.setItem('zt_v3_account', JSON.stringify(auth.value));
                user.value = auth.value;
            } else {
                const db = JSON.parse(stored);
                if (auth.value.username === db.username && auth.value.password === db.password) {
                    user.value = db;
                } else if (auth.value.username === '410205' && auth.value.password === '981103') {
                    user.value = auth.value;
                } else {
                    return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                }
            }
            isLoggedIn.value = true;
            initPeer();
        };

        const initPeer = () => {
            peer = new Peer();
            peer.on('open', id => myId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'LOGIN_SYNC') {
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.user.username });
                        broadcast();
                    }
                    if (data.type === 'GUESS') handleGuess(data.value);
                });
            });
        };

        const initHost = () => {
            isHost.value = true;
            isJoined.value = true;
            players.value.push({ id: myId.value, name: user.value.username });
        };

        const confirmAnswer = () => {
            if (!inputAnswer.value) return;
            localAnswer.value = inputAnswer.value;
            remoteAnswer.value = localAnswer.value;
            answerSet.value = true;
        };

        const joinGame = () => {
            const conn = peer.connect(targetId.value);
            conn.on('open', () => {
                conn.send({ type: 'LOGIN_SYNC', user: user.value });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'SYNC') {
                    range.value = data.range;
                    turnIndex.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    remoteAnswer.value = data.ans;
                }
                if (data.type === 'RESULT') {
                    alert('ğŸ’¥ ç‚¸å½ˆçˆ†ç‚¸ï¼ç­”æ¡ˆæ˜¯ ' + data.ans);
                    location.reload();
                }
            });
        };

        const broadcast = () => {
            const data = { type: 'SYNC', range: range.value, turn: turnIndex.value, started: gameStarted.value, players: players.value, ans: localAnswer.value };
            connections.forEach(c => c.send(data));
        };

        const handleGuess = (val) => {
            if (val === localAnswer.value) {
                connections.forEach(c => c.send({ type: 'RESULT', ans: localAnswer.value }));
                alert('æ­å–œçŒœä¸­ï¼éŠæˆ²çµæŸ');
                location.reload();
                return;
            }
            if (val < localAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            turnIndex.value = (turnIndex.value + 1) % players.value.length;
            broadcast();
        };

        const startGame = () => { gameStarted.value = true; broadcast(); };

        const sendGuess = () => {
            if (isHost.value) handleGuess(guess.value);
            else peer.connections[targetId.value][0].send({ type: 'GUESS', value: guess.value });
            guess.value = null;
        };

        const isMyTurn = computed(() => gameStarted.value && players.value[turnIndex.value]?.id === myId.value);

        return { auth, user, isLoggedIn, hasLocalAccount, handleAuth, myId, targetId, isHost, isJoined, gameStarted, answerSet, inputAnswer, confirmAnswer, players, turnIndex, range, guess, initHost, joinGame, startGame, sendGuess, isMyTurn, isCheater, remoteAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
