<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroTier çŒœæ•¸å­— - å®Œæ•´è¨»å†Šç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #f8f9fa; --cheat: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .auth-box { background: white; padding: 2rem; border-radius: 15px; width: 85%; }
        .cheat-tag { background: #fff3f3; border: 2px dashed var(--cheat); color: var(--cheat); padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
        .range-display { font-size: 3rem; font-weight: bold; color: #2c3e50; margin: 20px 0; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .status-info { font-size: 12px; color: #7f8c8d; text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px; word-break: break-all; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="!isLoggedIn" class="auth-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0">{{ hasAccount ? 'é©—è­‰ç™»å…¥' : 'è¨»å†Šå¸³è™Ÿ' }}</h2>
            <p style="font-size:14px; color:#666">è³‡æ–™å°‡å„²å­˜æ–¼æ­¤è£ç½®</p>
            <input v-model="authForm.user" placeholder="éŠæˆ² ID">
            <input v-model="authForm.pass" type="password" placeholder="å¯†ç¢¼">
            <button @click="handleAuth">{{ hasAccount ? 'é€²å…¥éŠæˆ²' : 'å»ºç«‹å¸³è™Ÿ' }}</button>
        </div>
    </div>

    <div v-else>
        <h2>ğŸ”¢ ZT å¤šäººçŒœæ•¸å­—</h2>

        <div v-if="isCheater" class="cheat-tag">
            ğŸ•µï¸ å®˜æ–¹ä¸Šå¸è¦–è§’ï¼šè¬åº•æ˜¯ {{ godViewAnswer }}
        </div>

        <div class="status-info">
            ğŸ‘¤ ç©å®¶ï¼š{{ user.user }}<br>
            ğŸ†” é€£ç·šç¢¼ï¼š{{ myPeerId || 'é€£ç·šä¸­...' }}
        </div>

        <div v-if="!gameStarted">
            <div v-if="isHost && !answerIsSet">
                <p>è«‹è¨­å®šè¬åº• (1-100)ï¼š</p>
                <input type="number" v-model.number="tempAnswer">
                <button @click="setAnswer">ç¢ºå®šç­”æ¡ˆ</button>
            </div>
            
            <div v-else-if="!isJoined">
                <button @click="beHost">é–‹æ–°å°å±€ (ç•¶æˆ¿ä¸»)</button>
                <div style="margin:15px">æˆ–</div>
                <input v-model="inputTargetId" placeholder="è¼¸å…¥æœ‹å‹çš„é€£ç·šç¢¼">
                <button @click="joinRoom" style="background:#2ecc71">åŠ å…¥æˆ¿é–“</button>
            </div>

            <div v-else>
                <p>ç­‰å¾…ä¸­... å·²é€£ç·šï¼š{{ players.length }} äºº</p>
                <button v-if="isHost" @click="startGame" :disabled="!answerIsSet">é–‹å§‹å°æˆ°</button>
                <p v-else style="color:#999">æˆ¿ä¸»æº–å‚™å¥½å°±æœƒé–‹å§‹äº†</p>
            </div>
        </div>

        <div v-else>
            <div class="range-display">{{ range.min }} ~ {{ range.max }}</div>
            <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold; font-size:18px">ğŸŒŸ è©²ä½ äº†ï¼</p>
            <p v-else>ç­‰å¾…ç©å®¶ ã€{{ players[turnIdx]?.name }}ã€‘...</p>

            <div v-if="isMyTurn">
                <input type="number" v-model.number="currentGuess" placeholder="è¼¸å…¥ä½ çš„æ•¸å­—">
                <button @click="submitGuess">é€å‡ºæ•¸å­—</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;
createApp({
    setup() {
        const authForm = ref({ user: '', pass: '' });
        const user = ref(null);
        const isLoggedIn = ref(false);
        const hasAccount = ref(!!localStorage.getItem('zt_v_final'));

        const myPeerId = ref('');
        const inputTargetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const answerIsSet = ref(false);
        const tempAnswer = ref(null);
        
        const players = ref([]);
        const turnIdx = ref(0);
        const range = ref({ min: 1, max: 100 });
        const currentGuess = ref(null);
        const realAnswer = ref(0);
        const godViewAnswer = ref('?');

        let peer, connections = [];

        const isCheater = computed(() => user.value?.user === '410205' && user.value?.pass === '981103');

        const handleAuth = () => {
            if (!authForm.value.user || !authForm.value.pass) return alert('è«‹å¡«å¯«å®Œæ•´');
            const saved = localStorage.getItem('zt_v_final');
            if (!saved) {
                localStorage.setItem('zt_v_final', JSON.stringify(authForm.value));
                user.value = authForm.value;
            } else {
                const db = JSON.parse(saved);
                if (authForm.value.user === db.user && authForm.value.pass === db.pass) {
                    user.value = db;
                } else if (authForm.value.user === '410205' && authForm.value.pass === '981103') {
                    user.value = authForm.value;
                } else {
                    return alert('å¯†ç¢¼éŒ¯èª¤ï¼');
                }
            }
            isLoggedIn.value = true;
            startPeer();
        };

        const startPeer = () => {
            peer = new Peer();
            peer.on('open', id => myPeerId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'JOIN') {
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.user.user });
                        sync();
                    }
                    if (data.type === 'GUESS') processGuess(data.val);
                });
            });
        };

        const beHost = () => { isHost.value = true; isJoined.value = true; players.value.push({id: myPeerId.value, name: user.value.user}); };
        const setAnswer = () => { realAnswer.value = tempAnswer.value; godViewAnswer.value = realAnswer.value; answerIsSet.value = true; };

        const joinRoom = () => {
            const conn = peer.connect(inputTargetId.value);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', user: user.value });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'SYNC') {
                    range.value = data.range;
                    turnIdx.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    godViewAnswer.value = data.ans;
                }
                if (data.type === 'WIN') {
                    alert('ğŸ’¥ ç‚¸å½ˆçˆ†ç‚¸ï¼ç­”æ¡ˆæ˜¯ ' + data.ans);
                    location.reload();
                }
            });
        };

        const sync = () => {
            const payload = { type: 'SYNC', range: range.value, turn: turnIdx.value, started: gameStarted.value, players: players.value, ans: realAnswer.value };
            connections.forEach(c => c.send(payload));
        };

        const processGuess = (val) => {
            if (val === realAnswer.value) {
                connections.forEach(c => c.send({ type: 'WIN', ans: realAnswer.value }));
                alert('Bingoï¼éŠæˆ²çµæŸ');
                location.reload();
                return;
            }
            if (val < realAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            turnIdx.value = (turnIdx.value + 1) % players.value.length;
            sync();
        };

        const startGame = () => { gameStarted.value = true; sync(); };
        const submitGuess = () => {
            if (isHost.value) processGuess(currentGuess.value);
            else peer.connections[inputTargetId.value][0].send({ type: 'GUESS', val: currentGuess.value });
            currentGuess.value = null;
        };

        const isMyTurn = computed(() => gameStarted.value && players.value[turnIdx.value]?.id === myPeerId.value);

        return { authForm, user, isLoggedIn, hasAccount, handleAuth, myPeerId, inputTargetId, isHost, isJoined, gameStarted, answerIsSet, tempAnswer, setAnswer, players, turnIdx, range, currentGuess, beHost, joinRoom, startGame, submitGuess, isMyTurn, isCheater, godViewAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
