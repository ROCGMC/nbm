<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroTier PWA çŒœæ•¸å­—</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f5f7fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        input { width: 80%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; width: 100%; margin: 5px 0; }
        button:disabled { background: #ccc; }
        .log-box { text-align: left; background: #eee; padding: 10px; border-radius: 8px; height: 150px; overflow-y: auto; margin-top: 15px; font-size: 14px; }
        #qrcode { margin: 15px auto; display: flex; justify-content: center; }
        .status { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h2>ğŸ”¢ ZeroTier çŒœæ•¸å­—</h2>
    <p class="status">ç¶²è·¯ ID: 8056c2e21cb160dd</p>

    <div v-if="!gameState">
        <p>æˆ‘çš„ ID: <strong>{{ myId || 'å–å¾—ä¸­...' }}</strong></p>
        <button @click="startHost" :disabled="!myId">ç•¶æˆ¿ä¸» (é–‹æ–°å±€)</button>
        <div style="margin: 20px 0; color: #aaa;">â€”â€” æˆ– â€”â€”</div>
        <input v-model="joinId" placeholder="è¼¸å…¥æˆ¿ä¸» ID">
        <button @click="joinGame" :disabled="!joinId">åŠ å…¥æœ‹å‹çš„å±€</button>
    </div>

    <div v-else>
        <h3 v-if="isHost">æˆ‘æ˜¯æˆ¿ä¸» (ç­”æ¡ˆ: {{ answer }})</h3>
        <h3 v-else>é€£ç·šæˆåŠŸï¼é–‹å§‹çŒœæ¸¬</h3>
        
        <div v-if="isHost && !peerConnected" id="qrcode"></div>
        <p v-if="isHost && !peerConnected">è«‹æœ‹å‹æƒææˆ–è¼¸å…¥ ID åŠ å…¥</p>

        <div v-if="peerConnected">
            <input type="number" v-model.number="userGuess" placeholder="è¼¸å…¥ 1-100">
            <button @click="submitGuess">é€å‡ºæ•¸å­—</button>
        </div>

        <div class="log-box">
            <div v-for="msg in logs">ğŸ‘‰ {{ msg }}</div>
        </div>
        <button @click="reset" style="background: #ff4757; margin-top: 10px;">çµæŸéŠæˆ²</button>
    </div>
</div>

<script>
const { createApp, ref, onMounted, nextTick } = Vue;

createApp({
    setup() {
        const myId = ref('');
        const joinId = ref('');
        const gameState = ref(false); // false, 'playing'
        const isHost = ref(false);
        const peerConnected = ref(false);
        const answer = ref(0);
        const userGuess = ref(null);
        const logs = ref(['ç­‰å¾…é–‹å§‹...']);
        
        let peer = null;
        let conn = null;

        onMounted(() => {
            // åˆå§‹åŒ– PeerJS
            peer = new Peer();
            peer.on('open', id => myId.value = id);
            
            // æˆ¿ä¸»ç›£è½é€£ç·š
            peer.on('connection', c => {
                conn = c;
                isHost.value = true;
                setupChat();
            });

            // è¨»å†Š PWA Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js');
            }
        });

        const startHost = () => {
            gameState.value = true;
            isHost.value = true;
            answer.value = Math.floor(Math.random() * 100) + 1;
            nextTick(() => {
                new QRCode(document.getElementById("qrcode"), {
                    text: myId.value,
                    width: 128, height: 128
                });
            });
        };

        const joinGame = () => {
            conn = peer.connect(joinId.value);
            gameState.value = true;
            isHost.value = false;
            setupChat();
        };

        const setupChat = () => {
            conn.on('open', () => {
                peerConnected.value = true;
                logs.value.unshift("å°æ–¹å·²é€£ç·šï¼");
            });
            conn.on('data', data => {
                if (isHost.value) {
                    processGuess(data);
                } else {
                    logs.value.unshift(data);
                }
            });
        };

        const processGuess = (num) => {
            let res = "";
            if (num > answer.value) res = `${num} å¤ªå¤§äº† â†‘`;
            else if (num < answer.value) res = `${num} å¤ªå°äº† â†“`;
            else res = `ğŸ‰ ç­”å°äº†ï¼ç­”æ¡ˆå°±æ˜¯ ${num}`;
            
            logs.value.unshift(`ç©å®¶çŒœäº† ${num}: ${res}`);
            conn.send(res);
        };

        const submitGuess = () => {
            if (userGuess.value === null) return;
            if (isHost.value) {
                processGuess(userGuess.value);
            } else {
                conn.send(userGuess.value);
                logs.value.unshift(`ä½ çŒœäº† ${userGuess.value}...`);
            }
            userGuess.value = null;
        };

        const reset = () => { location.reload(); };

        return { myId, joinId, gameState, isHost, peerConnected, answer, userGuess, logs, startHost, joinGame, submitGuess, reset };
    }
}).mount('#app');
</script>

</body>
</html>
