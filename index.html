<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒœæ•¸å­—</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        textarea { width: 100%; height: 80px; font-size: 12px; margin: 10px 0; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .hidden { display: none; }
        .log { background: #333; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="title">ğŸ” æœ¬åœ°å¸³è™Ÿç™»å…¥</h2>
    
    <div id="auth-ui">
        <input type="text" id="username" placeholder="ç©å®¶åç¨±" style="display:block; margin-bottom:10px; width:94%; padding:8px;">
        <input type="password" id="password" placeholder="å¯†ç¢¼" style="display:block; margin-bottom:10px; width:94%; padding:8px;">
        <button onclick="handleAuth()">è¨»å†Š/ç™»å…¥</button>
    </div>

    <div id="lobby-ui" class="hidden">
        <p>æ­¡è¿, <span id="display-name"></span></p>
        <hr>
        <h3>æ­¥é©Ÿ 1: å»ºç«‹é€£ç·š</h3>
        <button onclick="initiateOffer()">æˆ‘æ˜¯æˆ¿ä¸» (å»ºç«‹ Offer)</button>
        <p>è¤‡è£½ä¸‹æ–¹ä»£ç¢¼çµ¦æœ‹å‹ï¼š</p>
        <textarea id="local-offer" readonly placeholder="ç”¢ç”Ÿçš„ Offer æœƒå‡ºç¾åœ¨é€™"></textarea>
        
        <hr>
        <h3>æ­¥é©Ÿ 2: å›æ‡‰é€£ç·š</h3>
        <p>è²¼ä¸Šå°æ‰‹çš„ä»£ç¢¼ï¼š</p>
        <textarea id="remote-offer" placeholder="åœ¨æ­¤è²¼ä¸Š Offer æˆ– Answer"></textarea>
        <button onclick="acceptRemote()">ç¢ºèªé€£ç·š / å›å‚³ Answer</button>
    </div>

    <div id="game-ui" class="hidden">
        <h3 id="game-status">éŠæˆ²é€£ç·šæˆåŠŸï¼</h3>
        <div class="log" id="game-log"></div>
        <div style="margin-top:10px;">
            <input type="number" id="guess-input" placeholder="çŒœ 1-100">
            <button onclick="sendGuess()">é€å‡º</button>
        </div>
    </div>
</div>

<script>
    let pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
    let dc; // Data Channel
    let targetNum = Math.floor(Math.random() * 100) + 1;

    // --- å¸³å¯†ç³»çµ± ---
    function handleAuth() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(!u || !p) return alert("è«‹è¼¸å…¥å®Œæ•´");
        
        const saved = localStorage.getItem(`user_${u}`);
        if (saved && saved !== p) return alert("å¯†ç¢¼éŒ¯èª¤");
        
        localStorage.setItem(`user_${u}`, p);
        document.getElementById('display-name').innerText = u;
        document.getElementById('auth-ui').classList.add('hidden');
        document.getElementById('lobby-ui').classList.remove('hidden');
    }

    // --- WebRTC P2P é‚è¼¯ ---
    pc.onicecandidate = e => {
        if (e.candidate) return; // ç­‰å¾…æ‰€æœ‰ Candidate æ”¶é›†å®Œç•¢
        document.getElementById('local-offer').value = btoa(JSON.stringify(pc.localDescription));
    };

    pc.ondatachannel = e => {
        dc = e.channel;
        setupDataChannel();
    };

    // æˆ¿ä¸»ï¼šç™¼èµ·é€£ç·š
    async function initiateOffer() {
        dc = pc.createDataChannel("game");
        setupDataChannel();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    }

    // æ¥å—è€…ï¼šè™•ç† Offer æˆ– Answer
    async function acceptRemote() {
        const remoteData = JSON.parse(atob(document.getElementById('remote-offer').value));
        if (remoteData.type === "offer") {
            await pc.setRemoteDescription(remoteData);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
        } else {
            await pc.setRemoteDescription(remoteData);
        }
    }

    function setupDataChannel() {
        dc.onopen = () => {
            document.getElementById('lobby-ui').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            log("é€£ç·šå»ºç«‹ï¼é–‹å§‹éŠæˆ²...");
        };
        dc.onmessage = e => {
            const data = JSON.parse(e.data);
            if(data.type === 'guess') {
                const res = data.val == targetNum ? "ç­”å°äº†!" : (data.val > targetNum ? "å¤ªå¤§äº†" : "å¤ªå°äº†");
                log(`å°æ‰‹çŒœäº† ${data.val}: ${res}`);
                dc.send(JSON.stringify({type: 'result', res: res, val: data.val}));
            } else {
                log(`æˆ‘çŒœ ${data.val}: ${data.res}`);
            }
        };
    }

    function sendGuess() {
        const val = document.getElementById('guess-input').value;
        dc.send(JSON.stringify({type: 'guess', val: val}));
        document.getElementById('guess-input').value = '';
    }

    function log(msg) {
        const l = document.getElementById('game-log');
        l.innerHTML += `<div>> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }
</script>

</body>
</html>
