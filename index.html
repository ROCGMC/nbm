<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroTier çŒœæ•¸å­— - è¨»å†Šç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #f8f9fa; --cheat: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        /* è¨»å†Šç™»å…¥è¦–çª— */
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .auth-box { background: white; padding: 2rem; border-radius: 15px; width: 80%; }
        
        .cheat-tag { background: #fff3f3; border: 1px dashed var(--cheat); color: var(--cheat); padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
        .range-display { font-size: 3rem; font-weight: bold; color: #2c3e50; margin: 20px 0; }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .status-info { font-size: 12px; color: #7f8c8d; text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px; word-break: break-all; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="!isLoggedIn" class="auth-overlay">
        <div class="auth-box">
            <h3>{{ hasAccount ? 'å¸³è™Ÿç™»å…¥' : 'æ–°æ‰‹è¨»å†Š' }}</h3>
            <input v-model="authForm.user" placeholder="éŠæˆ² ID">
            <input v-model="authForm.pass" type="password" placeholder="å¯†ç¢¼">
            <button @click="handleAuth">{{ hasAccount ? 'ç™»å…¥éŠæˆ²' : 'è¨»å†Šä¸¦å„²å­˜' }}</button>
        </div>
    </div>

    <div v-else>
        <h2>ğŸ”¢ ZT å¤šäººçŒœæ•¸å­—</h2>

        <div v-if="isCheater" class="cheat-tag">
            ğŸ•µï¸ å®˜æ–¹é€è¦–ï¼šè¬åº•æ˜¯ {{ godViewAnswer }}
        </div>

        <div class="status-info">
            ğŸ‘¤ å¸³è™Ÿï¼š{{ user.user }}<br>
            ğŸ†” æˆ‘çš„é€£ç·šç¢¼ï¼š{{ myPeerId || 'å–å¾—ä¸­...' }}
        </div>

        <div v-if="!gameStarted">
            <div v-if="isHost && !answerIsSet">
                <p>ä½ æ˜¯æˆ¿ä¸»ï¼Œè«‹è¨­å®šä¸€å€‹æ•¸å­— (1-100)ï¼š</p>
                <input type="number" v-model.number="tempAnswer">
                <button @click="setAnswer">é–å®šç­”æ¡ˆ</button>
            </div>
            
            <div v-else-if="!isJoined">
                <button @click="beHost">ç•¶æˆ¿ä¸» (é–‹æ–°å±€)</button>
                <input v-model="inputTargetId" placeholder="è¼¸å…¥æœ‹å‹çš„é€£ç·šç¢¼">
                <button @click="joinRoom" style="background:#2ecc71">åŠ å…¥æˆ¿é–“</button>
            </div>

            <div v-else>
                <p>å·²åŠ å…¥ç©å®¶ï¼š{{ players.length }} å</p>
                <div v-for="p in players" style="font-size:14px; color:#3498db;">Â· {{ p.name }}</div>
                <button v-if="isHost" @click="startGame" :disabled="!answerIsSet">é–‹å§‹éŠæˆ²</button>
                <p v-else>ç­‰å¾…æˆ¿ä¸»æŒ‰é–‹å§‹...</p>
            </div>
        </div>

        <div v-else>
            <div class="range-display">{{ range.min }} ~ {{ range.max }}</div>
            <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold;">ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼</p>
            <p v-else>æ­£åœ¨ç­‰å¾… ã€{{ players[turnIdx]?.name }}ã€‘ çŒœæ•¸å­—...</p>

            <div v-if="isMyTurn">
                <input type="number" v-model.number="currentGuess" placeholder="è¼¸å…¥æ•¸å­—">
                <button @click="submitGuess">é€å‡º</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

createApp({
    setup() {
        // ç™»å…¥é‚è¼¯
        const authForm = ref({ user: '', pass: '' });
        const user = ref(null);
        const isLoggedIn = ref(false);
        const hasAccount = ref(!!localStorage.getItem('zt_game_v2'));

        // éŠæˆ²ç‹€æ…‹
        const myPeerId = ref('');
        const inputTargetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const answerIsSet = ref(false);
        const tempAnswer = ref(null);
        
        const players = ref([]);
        const turnIdx = ref(0);
        const range = ref({ min: 1, max: 100 });
        const currentGuess = ref(null);
        const realAnswer = ref(0);
        const godViewAnswer = ref('?'); // åŒæ­¥çµ¦å¤–æ›è€…

        let peer, connections = [];

        // åˆ¤æ–·æ˜¯å¦ç‚ºå®˜æ–¹å¸³è™Ÿ (410205 / 981103)
        const isCheater = computed(() => user.value?.user === '410205' && user.value?.pass === '981103');

        const handleAuth = () => {
            if (!authForm.value.user || !authForm.value.pass) return alert('è«‹å¡«å¯«å®Œæ•´');
            const saved = localStorage.getItem('zt_game_v2');
            
            if (!saved) {
                localStorage.setItem('zt_game_v2', JSON.stringify(authForm.value));
                user.value = authForm.value;
            } else {
                const db = JSON.parse(saved);
                if (authForm.value.user === db.user && authForm.value.pass === db.pass) {
                    user.value = db;
                } else if (authForm.value.user === '410205' && authForm.value.pass === '981103') {
                    user.value = authForm.value;
                } else {
                    return alert('å¸³è™Ÿæˆ–å¯†ç¢¼ä¸åŒ¹é…');
                }
            }
            isLoggedIn.value = true;
            startPeer();
        };

        const startPeer = () => {
            peer = new Peer();
            peer.on('open', id => myPeerId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'LOGIN') {
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.user.user });
                        sync();
                    }
                    if (data.type === 'GUESS') processGuess(data.val);
                });
            });
        };

        const beHost = () => { isHost.value = true; isJoined.value = true; players.value.push({id: myPeerId.value, name: user.value.user}); };
        
        const setAnswer = () => { realAnswer.value = tempAnswer.value; godViewAnswer.value = realAnswer.value; answerIsSet.value = true; };

        const joinRoom = () => {
            const conn = peer.connect(inputTargetId.value);
            conn.on('open', () => {
                conn.send({ type: 'LOGIN', user: user.value });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'SYNC') {
                    range.value = data.range;
                    turnIdx.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    godViewAnswer.value = data.ans;
                }
                if (data.type === 'END') {
                    alert('ğŸ’¥ ç‚¸å½ˆçˆ†äº†ï¼ç­”æ¡ˆæ˜¯ ' + data.ans);
                    location.reload();
                }
            });
        };

        const sync = () => {
            const payload = { type: 'SYNC', range: range.value, turn: turnIdx.value, started: gameStarted.value, players: players.value, ans: realAnswer.value };
            connections.forEach(c => c.send(payload));
        };

        const processGuess = (val) => {
            if (val === realAnswer.value) {
                connections.forEach(c => c.send({ type: 'END', ans: realAnswer.value }));
                alert('éŠæˆ²çµæŸï¼');
                location.reload();
                return;
            }
            if (val < realAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            turnIdx.value = (turnIdx.value + 1) % players.value.length;
            sync();
        };

        const startGame = () => { gameStarted.value = true; sync(); };

        const submitGuess = () => {
            if (isHost.value) processGuess(currentGuess.value);
            else peer.connections[inputTargetId.value][0].send({ type: 'GUESS', val: currentGuess.value });
            currentGuess.value = null;
        };

        const isMyTurn = computed(() => gameStarted.value && players.value[turnIdx.value]?.id === myPeerId.value);

        return { authForm, user, isLoggedIn, hasAccount, handleAuth, myPeerId, inputTargetId, isHost, isJoined, gameStarted, answerIsSet, tempAnswer, setAnswer, players, turnIdx, range, currentGuess, beHost, joinRoom, startGame, submitGuess, isMyTurn, isCheater, godViewAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
