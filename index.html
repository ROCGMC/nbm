<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZT çŒœæ•¸å­— - å¯¦æ™‚æ•¸æ“šç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #0984e3; --bg: #dfe6e9; --cheat: #d63031; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        /* è¨»å†Šç™»å…¥å½ˆçª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 2rem; border-radius: 15px; width: 80%; }

        .range-box { font-size: 3rem; font-weight: bold; color: var(--cheat); margin: 20px 0; }
        .cheat-box { background: #ffeaa7; border: 2px dashed #fdcb6e; padding: 10px; border-radius: 10px; color: #d35400; font-weight: bold; margin-bottom: 10px; }
        
        input { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        .status-bar { font-size: 12px; color: #636e72; background: #f1f2f6; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: left; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="!isLoggedIn" class="modal">
        <div class="modal-content">
            <h2 v-if="!hasLocalAccount">ğŸ†• å»ºç«‹éŠæˆ²å¸³è™Ÿ</h2>
            <h2 v-else>ğŸ” ç™»å…¥é©—è­‰</h2>
            <input v-model="auth.username" placeholder="ä½¿ç”¨è€… ID (ä¾‹å¦‚: 410205)">
            <input v-model="auth.password" type="password" placeholder="å¯†ç¢¼ (ä¾‹å¦‚: 981103)">
            <button @click="handleAuth">{{ hasLocalAccount ? 'é€²å…¥éŠæˆ²' : 'è¨»å†Šä¸¦å„²å­˜' }}</button>
            <p v-if="!hasLocalAccount" style="font-size: 11px; color: #d63031; margin-top:10px;">* è³‡æ–™å°‡åŠ å¯†å­˜åœ¨æ‚¨çš„æ‰‹æ©Ÿæœ¬åœ°</p>
        </div>
    </div>

    <div v-else>
        <h2>ğŸ® ZT çŒœæ•¸å­—å°æˆ°</h2>
        
        <div v-if="isCheater" class="cheat-box">
            ğŸ•µï¸ å®˜æ–¹é€è¦–å•Ÿå‹•ï¼šç›®æ¨™æ•¸å­— {{ remoteAnswer }}
        </div>

        <div class="status-bar">
            ğŸ‘¤ ç©å®¶ï¼š{{ user.username }}<br>
            ğŸ†” æˆ‘çš„é€£ç·šç¢¼ï¼š{{ myId || 'å–å¾—ä¸­...' }}
        </div>

        <div v-if="!gameStarted">
            <div v-if="isHost && !answerSet">
                <input type="number" v-model.number="inputAnswer" placeholder="è«‹æˆ¿ä¸»è¨­å®š 1-100">
                <button @click="confirmAnswer">é–å®šç­”æ¡ˆ</button>
            </div>
            
            <div v-else-if="!isJoined">
                <button @click="initHost">æˆ‘æ˜¯æˆ¿ä¸»</button>
                <div style="margin: 10px;">æˆ–</div>
                <input v-model="targetId" placeholder="è¼¸å…¥æˆ¿ä¸»é€£ç·šç¢¼">
                <button @click="joinGame" style="background:#00b894">åŠ å…¥æˆ¿é–“</button>
            </div>

            <div v-else>
                <p>ç­‰å¾…å°å±€é–‹å§‹... (å·²é€£ç·š: {{ players.length }} äºº)</p>
                <button v-if="isHost" @click="startGame" :disabled="!answerSet">é–‹å§‹å°å±€</button>
            </div>
        </div>

        <div v-else>
            <div class="range-box">{{ range.min }} ~ {{ range.max }}</div>
            <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold; font-size:1.2rem;">ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼</p>
            <p v-else>ç­‰å¾…ç©å®¶ ã€{{ players[turnIndex]?.name }}ã€‘</p>

            <div v-if="isMyTurn">
                <input type="number" v-model.number="guess" :placeholder="'è«‹è¼¸å…¥ç¯„åœå…§æ•¸å­—'">
                <button @click="sendGuess">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const auth = ref({ username: '', password: '' });
        const user = ref(null);
        const isLoggedIn = ref(false);
        const hasLocalAccount = ref(!!localStorage.getItem('zt_user_v2'));

        const myId = ref('');
        const targetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const answerSet = ref(false);
        const inputAnswer = ref(null);
        
        const players = ref([]); // åŒ…å«åŒæ­¥éä¾†çš„å¸³è™Ÿè³‡è¨Š
        const turnIndex = ref(0);
        const range = ref({ min: 1, max: 100 });
        const guess = ref(null);
        const localAnswer = ref(0);
        const remoteAnswer = ref('?');

        let peer, connections = [];

        // å®˜æ–¹å¤–æ›åˆ¤æ–· (410205 / 981103)
        const isCheater = computed(() => user.value?.username === '410205' && user.value?.password === '981103');

        // 1. è¨»å†Šç™»å…¥é‚è¼¯
        const handleAuth = () => {
            const stored = localStorage.getItem('zt_user_v2');
            if (!stored) {
                // è¨»å†Š
                localStorage.setItem('zt_user_v2', JSON.stringify(auth.value));
                user.value = auth.value;
            } else {
                // ç™»å…¥
                const db = JSON.parse(stored);
                if (auth.value.username === db.username && auth.value.password === db.password) {
                    user.value = db;
                } else if (auth.value.username === '410205' && auth.value.password === '981103') {
                    user.value = auth.value; // å®˜æ–¹å¾Œé–€ç›´æ¥é€²
                } else {
                    return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                }
            }
            isLoggedIn.value = true;
            initPeer();
        };

        // 2. Peer é€£çµèˆ‡ ZeroTier äº’å‚³
        const initPeer = () => {
            peer = new Peer();
            peer.on('open', id => myId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'SYNC_USER') {
                        // æˆ¿ä¸»æ¥æ”¶ç©å®¶é€é ZT å‚³ä¾†çš„ã€Œæœ¬åœ°å¸³å¯†è³‡æ–™ã€
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.user.username });
                        broadcastSync(); // å»£æ’­çµ¦æ‰€æœ‰äººæ›´æ–°åå–®
                    }
                    if (data.type === 'GUESS') handleGuess(data.value);
                });
            });
        };

        const initHost = () => {
            isHost.value = true;
            isJoined.value = true;
            players.value.push({ id: myId.value, name: user.value.username });
        };

        const confirmAnswer = () => {
            localAnswer.value = inputAnswer.value;
            remoteAnswer.value = localAnswer.value;
            answerSet.value = true;
        };

        const joinGame = () => {
            const conn = peer.connect(targetId.value);
            conn.on('open', () => {
                // é€£ç·šæˆåŠŸå¾Œï¼Œç«‹å³æŠŠã€Œæœ¬åœ°å¸³è™Ÿã€å‚³çµ¦æˆ¿ä¸»å„²å­˜
                conn.send({ type: 'SYNC_USER', user: user.value });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'BROADCAST') {
                    range.value = data.range;
                    turnIndex.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    remoteAnswer.value = data.ans;
                }
                if (data.type === 'WIN') {
                    alert('ğŸ’¥ çˆ†ç‚¸ï¼ç­”æ¡ˆæ˜¯ ' + data.ans);
                    location.reload();
                }
            });
        };

        const broadcastSync = () => {
            const data = { 
                type: 'BROADCAST', 
                range: range.value, 
                turn: turnIndex.value, 
                started: gameStarted.value, 
                players: players.value, 
                ans: localAnswer.value 
            };
            connections.forEach(c => c.send(data));
        };

        const handleGuess = (val) => {
            if (val === localAnswer.value) {
                connections.forEach(c => c.send({ type: 'WIN', ans: localAnswer.value }));
                alert('éŠæˆ²çµæŸï¼');
                location.reload();
                return;
            }
            if (val < localAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            
            turnIndex.value = (turnIndex.value + 1) % players.value.length;
            broadcastSync();
        };

        const startGame = () => { gameStarted.value = true; broadcastSync(); };

        const sendGuess = () => {
            if (isHost.value) handleGuess(guess.value);
            else peer.connections[targetId.value][0].send({ type: 'GUESS', value: guess.value });
            guess.value = null;
        };

        const isMyTurn = computed(() => {
            return gameStarted.value && players.value[turnIndex.value]?.id === myId.value;
        });

        return { auth, user, isLoggedIn, hasLocalAccount, handleAuth, myId, targetId, isHost, isJoined, gameStarted, answerSet, inputAnswer, confirmAnswer, players, turnIndex, range, guess, initHost, joinGame, startGame, sendGuess, isMyTurn, isCheater, remoteAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
