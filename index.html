<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>多人猜數字 PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        #app { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: #333; margin-bottom: 5px; }
        #status { font-size: 0.9rem; color: #666; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); }
        button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:active { transform: scale(0.98); }
        #history { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        .guess-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .guess-item strong { color: var(--primary); font-size: 0.8rem; }
        .badge { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="app">
        <h1>猜數字大戰</h1>
        <div id="status">正在連線至 Firebase...</div>
        
        <div class="input-group">
            <input type="number" id="guessInput" placeholder="1-100" min="1" max="100">
            <button onclick="sendGuess()">送出</button>
        </div>

        <ul id="history"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // 你的 Firebase 配置 (請確保與你截圖的一致)
        const firebaseConfig = {
            apiKey: "AIzaSyCjjfEnkLeaRXZsFPVxjwDWxz1IqbOBN7A",
            authDomain: "nbms-3dc57.firebaseapp.com",
            projectId: "nbms-3dc57",
            storageBucket: "nbms-3dc57.firebasestorage.app",
            messagingSenderId: "495363300459",
            appId: "1:495363300459:web:5494e7f2d37c8a12e0252e",
            measurementId: "G-8VHTY3E28B",
            databaseURL: "https://nbms-3dc57-default-rtdb.firebaseio.com" // 注意：通常需要手動加上 databaseURL
        };

        // 初始化
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const guessesRef = ref(db, 'game/guesses');

        // 生成簡單的匿名 ID
        const myId = "玩家_" + Math.random().toString(36).substring(7, 10);

        // 監聽數據
        onValue(guessesRef, (snapshot) => {
            const data = snapshot.val();
            const list = document.getElementById('history');
            const status = document.getElementById('status');
            list.innerHTML = '';
            
            if (!data) {
                status.innerText = "等待挑戰者...";
                return;
            }

            status.innerText = `連線成功！你是 ${myId}`;

            // 轉成陣列並排序（最新的在上面）
            const entries = Object.values(data).sort((a, b) => b.time - a.time);
            entries.forEach(guess => {
                const li = document.createElement('li');
                li.className = 'guess-item';
                li.innerHTML = `<strong>${guess.player}</strong> <span class="badge">${guess.number}</span>`;
                list.appendChild(li);
            });
        });

        // 定義送出功能
        window.sendGuess = function() {
            const input = document.getElementById('guessInput');
            const val = input.value;
            if (!val) return;

            push(guessesRef, {
                player: myId,
                number: parseInt(val),
                time: Date.now()
            });
            input.value = '';
        };

        // 註冊 PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW 註冊成功'))
                    .catch(err => console.log('SW 註冊失敗', err));
            });
        }
    </script>
</body>
</html>
