<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZT çŒœæ•¸å­— - å¸³å¯†å¤–æ›ç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --bg: #f0f2f5; --cheat: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        /* å¤–æ›æ¨£å¼ */
        .cheat-panel { color: var(--cheat); font-weight: bold; font-size: 14px; margin: 10px 0; border: 2px solid var(--cheat); padding: 10px; border-radius: 10px; background: #fff5f5; position: relative; overflow: hidden; }
        .cheat-panel::before { content: "SECRET"; position: absolute; top: -5px; right: -5px; font-size: 8px; background: var(--cheat); color: white; padding: 2px 5px; transform: rotate(15deg); }
        
        .login-box { display: flex; flex-direction: column; gap: 10px; }
        .range-box { font-size: 2.8rem; font-weight: bold; color: #d63031; margin: 15px 0; letter-spacing: 2px; }
        input { width: 100%; box-sizing: border-box; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .log-list { background: #2d3436; color: #00cec9; padding: 12px; border-radius: 10px; height: 120px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; text-align: left; margin-top: 15px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h2 style="margin-top: 0;">ğŸ² ZT å¤šäººå°æˆ°</h2>

    <div v-if="!isLoggedIn" class="login-box">
        <p style="color: #666;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä»¥é€£æ¥ ZeroTier ç¶²è·¯</p>
        <input v-model="auth.username" placeholder="ä½¿ç”¨è€… ID">
        <input v-model="auth.password" type="password" placeholder="å¯†ç¢¼">
        <button @click="handleLogin">ç¢ºèªç™»å…¥</button>
        <p style="font-size: 11px; color: #999;">å®˜æ–¹å¸³è™Ÿå¯é–‹å•Ÿé€è¦–æ¨¡å¼</p>
    </div>

    <div v-else-if="!gameStarted">
        <div v-if="isCheater" class="cheat-panel">ğŸ”“ å®˜æ–¹æ ¸å¿ƒå·²è§£é–ï¼šé€è¦–ã€ç›£è½å°±ç·’</div>
        <p>æ­¡è¿å›ä¾†ï¼Œ<span style="color:var(--primary); font-weight:bold;">{{ auth.username }}</span></p>
        
        <div v-if="isHost && !answerSet" style="background:#f9f9f9; padding:15px; border-radius:10px;">
            <h4>è¨­å®šæœ¬å±€è¬åº•</h4>
            <input type="number" v-model.number="inputAnswer" placeholder="è«‹è¨­å®š 1-100">
            <button @click="confirmAnswer" style="margin-top:10px">é–å®šç­”æ¡ˆ</button>
        </div>

        <div v-else-if="!isJoined">
            <button @click="initHost">é–‹å•Ÿå°å±€ (æˆ‘æ˜¯æˆ¿ä¸»)</button>
            <div style="margin: 15px 0; color:#ccc;">â€”â€” æˆ–æ˜¯ â€”â€”</div>
            <input v-model="targetId" placeholder="è²¼ä¸Šæˆ¿ä¸»çš„ Peer ID">
            <button @click="joinAsPlayer" style="background:#00b894; margin-top:10px">åŠ å…¥å¥½å‹æˆ¿é–“</button>
        </div>

        <div v-else>
            <p style="font-size:12px; background:#eee; padding:5px;">æˆ‘çš„é€£ç·š ID: {{ myId }}</p>
            <div style="text-align:left; margin:10px 0;">
                <p>ğŸ‘¥ å·²æº–å‚™ç©å®¶ ({{ players.length }}):</p>
                <div v-for="(p, i) in players" :key="i">Â· {{ p.name }} {{ i===0 ? 'ğŸ‘‘' : '' }}</div>
            </div>
            <button v-if="isHost" @click="startGame" :disabled="!answerSet">å…¨å“¡åˆ°é½Šï¼Œé–‹å§‹éŠæˆ²</button>
            <p v-else style="color:#666; font-style:italic;">ç­‰å¾…æˆ¿ä¸»ç™¼èµ·æŒ‘æˆ°...</p>
        </div>
    </div>

    <div v-else>
        <div v-if="isCheater" class="cheat-panel">
            ğŸ‘ï¸ åµæ¸¬åˆ°æˆ¿ä¸»è³‡æ–™ï¼šç­”æ¡ˆæ˜¯ {{ remoteAnswer }}
        </div>

        <div class="range-box">{{ range.min }} < ? < {{ range.max }}</div>
        
        <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold; font-size:18px;">ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼Œè«‹çŒœä¸€å€‹æ•¸ï¼</p>
        <p v-else style="color:#666;">ç­‰å¾…ç©å®¶ ã€{{ players[turnIndex]?.name }}ã€‘...</p>

        <div v-if="isMyTurn">
            <input type="number" v-model.number="guess" :placeholder="'è«‹è¼¸å…¥ ' + range.min + '~' + range.max">
            <button @click="sendGuess" style="margin-top:10px">ç™¼é€æ•¸å­—</button>
        </div>

        <div class="log-list">
            <div v-for="l in logs">>> {{ l }}</div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const auth = ref({ username: '', password: '' });
        const isLoggedIn = ref(false);
        const myId = ref('');
        const targetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const answerSet = ref(false);
        const inputAnswer = ref(null);
        
        const players = ref([]);
        const turnIndex = ref(0);
        const range = ref({ min: 1, max: 100 });
        const logs = ref(["ç³»çµ±å·²å°±ç·’"]);
        const guess = ref(null);
        
        const localAnswer = ref(0); 
        const remoteAnswer = ref('ç­‰å¾…æ•¸æ“š...'); 
        
        let peer, connections = [];

        // å®˜æ–¹å¤–æ›å¸³å¯†åˆ¤æ–·
        const isCheater = computed(() => {
            return auth.value.username === '410205' && auth.value.password === '981103';
        });

        const handleLogin = () => {
            if (auth.value.username && auth.value.password) {
                isLoggedIn.value = true;
                localStorage.setItem('zt_game_user', JSON.stringify(auth.value));
                initPeer();
            } else {
                alert("è«‹å®Œæ•´è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
            }
        };

        const initPeer = () => {
            peer = new Peer();
            peer.on('open', id => myId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'JOIN') {
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.name });
                        sync(`ç©å®¶ ${data.name} å·²é€²å…¥`);
                    }
                    if (data.type === 'GUESS') handleGuess(data.value);
                });
            });
        };

        const initHost = () => {
            isHost.value = true;
            isJoined.value = true;
            players.value.push({ id: myId.value, name: auth.value.username });
        };

        const confirmAnswer = () => {
            localAnswer.value = inputAnswer.value;
            remoteAnswer.value = localAnswer.value;
            answerSet.value = true;
            logs.value.unshift("æˆ¿ä¸»å·²è¨­å®šç­”æ¡ˆã€‚");
        };

        const joinAsPlayer = () => {
            const conn = peer.connect(targetId.value);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: auth.value.username });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'SYNC') {
                    range.value = data.range;
                    turnIndex.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    remoteAnswer.value = data.ans; // æ•¸æ“šåŒ…ä¸­éš±è—ç­”æ¡ˆ
                    if (data.msg) logs.value.unshift(data.msg);
                }
                if (data.type === 'WIN') {
                    alert('ğŸ’¥ ç‚¸å½ˆçˆ†ç‚¸äº†ï¼ç©å®¶ ' + data.winner + ' çŒœä¸­äº†ç­”æ¡ˆ ' + data.ans);
                    location.reload();
                }
            });
        };

        const sync = (msg) => {
            const data = { 
                type: 'SYNC', 
                range: range.value, 
                turn: turnIndex.value, 
                started: gameStarted.value, 
                players: players.value, 
                ans: localAnswer.value, 
                msg 
            };
            connections.forEach(c => c.send(data));
        };

        const handleGuess = (val) => {
            let currentPlayerName = players.value[turnIndex.value].name;
            if (val === localAnswer.value) {
                connections.forEach(c => c.send({ type: 'WIN', winner: currentPlayerName, ans: localAnswer.value }));
                alert('éŠæˆ²çµæŸï¼ä½ è¼¸äº†ï¼ˆæˆ–è´äº†ï¼‰');
                location.reload();
                return;
            }
            if (val < localAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            
            turnIndex.value = (turnIndex.value + 1) % players.value.length;
            sync(`${currentPlayerName} çŒœäº† ${val}`);
            logs.value.unshift(`${currentPlayerName} çŒœäº† ${val}`);
        };

        const startGame = () => { 
            if (!answerSet.value) return alert("è«‹å…ˆè¨­å®šç­”æ¡ˆï¼");
            gameStarted.value = true; 
            sync('å°å±€æ­£å¼é–‹å§‹ï¼'); 
        };

        const sendGuess = () => {
            if (guess.value <= range.value.min || guess.value >= range.value.max) return alert('è«‹è¼¸å…¥æœ‰æ•ˆç¯„åœå…§çš„æ•¸å­—ï¼');
            if (isHost.value) handleGuess(guess.value);
            else peer.connections[targetId.value][0].send({ type: 'GUESS', value: guess.value });
            guess.value = null;
        };

        const isMyTurn = computed(() => {
            return gameStarted.value && players.value[turnIndex.value]?.id === myId.value;
        });

        return { auth, isLoggedIn, handleLogin, myId, targetId, isHost, isJoined, gameStarted, answerSet, inputAnswer, confirmAnswer, players, turnIndex, range, logs, guess, initHost, joinAsPlayer, startGame, sendGuess, isMyTurn, isCheater, remoteAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
