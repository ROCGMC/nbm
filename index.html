<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZT çŒœæ•¸å­— - å®˜æ–¹æˆæ¬Šç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --bg: #dfe6e9; --cheat: #ff4757; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; position: relative; }
        .cheat-overlay { color: var(--cheat); font-weight: bold; font-size: 12px; margin-top: 5px; border: 1px dashed var(--cheat); padding: 5px; border-radius: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .range-box { font-size: 2.5rem; font-weight: bold; color: #d63031; margin: 20px 0; }
        .player-list { background: #f1f2f6; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        input { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; }
        .log { background: #2d3436; color: #fab1a0; padding: 10px; border-radius: 8px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 13px; text-align: left; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h2>ğŸ” ZT çŒœæ•¸å­—å°æˆ°</h2>

    <div v-if="!isLoggedIn">
        <h3>å¸³è™Ÿç™»å…¥</h3>
        <input v-model="auth.username" placeholder="éŠæˆ² ID">
        <input v-model="auth.password" type="password" placeholder="å¯†ç¢¼">
        <button @click="login">ç™»å…¥</button>
    </div>

    <div v-else-if="!gameStarted">
        <div v-if="isCheater" class="cheat-overlay">âš ï¸ å®˜æ–¹å¤–æ›å·²å•Ÿå‹•ï¼šèº«åˆ†é©—è­‰æˆåŠŸ</div>
        <p>æ­¡è¿å›æ­¸ï¼Œ{{ auth.username }}</p>
        
        <div v-if="!isJoined">
            <button @click="initHost">å»ºç«‹æ–°æˆ¿é–“</button>
            <input v-model="targetId" placeholder="æˆ¿ä¸» ID" style="margin-top:15px">
            <button @click="joinAsPlayer" style="background:#00b894">åŠ å…¥å°å±€</button>
        </div>
        <div v-else>
            <div class="player-list">
                <div v-for="(p, i) in players">
                    {{ i+1 }}. {{ p.name }} {{ i === 0 ? '(æˆ¿ä¸»)' : '' }}
                </div>
            </div>
            <button v-if="isHost" @click="startGame">é–‹å§‹éŠæˆ²</button>
            <p v-else>ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</p>
        </div>
    </div>

    <div v-else>
        <div v-if="isCheater" class="cheat-overlay">
            ã€ç³»çµ±è¿½è¹¤ã€‘æˆ¿ä¸»è¨­å®šçš„æ•¸å­—æ˜¯ï¼š{{ remoteAnswer }}
        </div>

        <div class="range-box">{{ range.min }} ~ {{ range.max }}</div>
        
        <p v-if="isMyTurn" style="color:var(--primary); font-weight:bold;">ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼</p>
        <p v-else>ç­‰å¾… {{ players[turnIndex].name }}...</p>

        <div v-if="isMyTurn">
            <input type="number" v-model.number="guess" :placeholder="'è¼¸å…¥ ' + range.min + '~' + range.max">
            <button @click="sendGuess">ç¢ºèªé€å‡º</button>
        </div>

        <div class="log">
            <div v-for="l in logs">{{ l }}</div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

createApp({
    setup() {
        const auth = ref({ username: '', password: '' });
        const isLoggedIn = ref(false);
        const myId = ref('');
        const targetId = ref('');
        const isHost = ref(false);
        const isJoined = ref(false);
        const gameStarted = ref(false);
        const players = ref([]);
        const turnIndex = ref(0);
        const range = ref({ min: 1, max: 100 });
        const logs = ref([]);
        const guess = ref(null);
        
        const localAnswer = ref(0); // æˆ¿ä¸»ç«¯ç­”æ¡ˆ
        const remoteAnswer = ref('?'); // åŒæ­¥çµ¦å¤–æ›å¸³è™Ÿçš„ç­”æ¡ˆ
        
        let peer, connections = [];

        const isCheater = computed(() => {
            return auth.value.username === '410205' && auth.value.password === '981103';
        });

        const login = () => {
            if (auth.value.username) {
                isLoggedIn.value = true;
                initPeer();
            }
        };

        const initPeer = () => {
            peer = new Peer();
            peer.on('open', id => myId.value = id);
            peer.on('connection', conn => {
                if (!isHost.value) return;
                conn.on('data', data => {
                    if (data.type === 'JOIN') {
                        connections.push(conn);
                        players.value.push({ id: conn.peer, name: data.name });
                        sync();
                    }
                    if (data.type === 'GUESS') handleGuess(data.value);
                });
            });
        };

        const initHost = () => {
            isHost.value = true;
            isJoined.value = true;
            players.value.push({ id: myId.value, name: auth.value.username });
            localAnswer.value = Math.floor(Math.random() * 100) + 1;
            remoteAnswer.value = localAnswer.value;
        };

        const joinAsPlayer = () => {
            const conn = peer.connect(targetId.value);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: auth.value.username });
                isJoined.value = true;
            });
            conn.on('data', data => {
                if (data.type === 'SYNC') {
                    range.value = data.range;
                    turnIndex.value = data.turn;
                    gameStarted.value = data.started;
                    players.value = data.players;
                    // é‡é»ï¼šæˆ¿ä¸»åŒæ­¥æ•¸æ“šæ™‚ï¼Œä¹ŸæœƒæŠŠç­”æ¡ˆå‚³çµ¦é€£ç·šè€…
                    // åœ¨æ­£å¸¸ä»‹é¢ä¸æœƒé¡¯ç¤ºï¼Œåªæœ‰ isCheater æœƒçœ‹åˆ°
                    remoteAnswer.value = data.ans;
                    if (data.msg) logs.value.unshift(data.msg);
                }
                if (data.type === 'WIN') alert('ç‚¸å½ˆçˆ†äº†ï¼ç­”æ¡ˆæ˜¯ ' + data.ans);
            });
        };

        const sync = (msg) => {
            const data = { 
                type: 'SYNC', 
                range: range.value, 
                turn: turnIndex.value, 
                started: gameStarted.value, 
                players: players.value, 
                ans: localAnswer.value, // æˆ¿ä¸»å»£æ’­ç­”æ¡ˆï¼ˆéš±è—åœ¨æ•¸æ“šåŒ…ä¸­ï¼‰
                msg 
            };
            connections.forEach(c => c.send(data));
        };

        const handleGuess = (val) => {
            if (val === localAnswer.value) {
                connections.forEach(c => c.send({ type: 'WIN', ans: localAnswer.value }));
                alert('çµæŸï¼ç­”æ¡ˆæ˜¯ ' + localAnswer.value);
                return;
            }
            if (val < localAnswer.value) range.value.min = Math.max(range.value.min, val);
            else range.value.max = Math.min(range.value.max, val);
            
            turnIndex.value = (turnIndex.value + 1) % players.value.length;
            sync(`ç©å®¶çŒœäº† ${val}`);
            logs.value.unshift(`ç©å®¶çŒœäº† ${val}`);
        };

        const startGame = () => { gameStarted.value = true; sync('éŠæˆ²é–‹å§‹ï¼'); };

        const sendGuess = () => {
            if (isHost.value) handleGuess(guess.value);
            else peer.connections[targetId.value][0].send({ type: 'GUESS', value: guess.value });
            guess.value = null;
        };

        const isMyTurn = computed(() => {
            return gameStarted.value && players.value[turnIndex.value]?.id === myId.value;
        });

        return { auth, isLoggedIn, login, myId, targetId, isHost, isJoined, gameStarted, players, turnIndex, range, logs, guess, initHost, joinAsPlayer, startGame, sendGuess, isMyTurn, isCheater, remoteAnswer };
    }
}).mount('#app');
</script>
</body>
</html>
